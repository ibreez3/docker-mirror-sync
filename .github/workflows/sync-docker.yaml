# å·¥ä½œæµåç§°ï¼Œè‡ªå®šä¹‰
name: Docker é•œåƒåŒæ­¥ (æ‹‰å– â†’ æ¨é€é˜¿é‡Œäº‘ACR)

# è§¦å‘è§„åˆ™ï¼š
on:
  # æ–¹å¼1ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ–¹å¼2ï¼šä»£ç æ¨é€è§¦å‘
  push:
    branches: [ "main", "master" ]
    paths:
      - 'mirror-list.txt'                   # å½“é•œåƒåˆ—è¡¨å˜åŒ–æ—¶è§¦å‘
      # - '.github/workflows/sync-docker.yaml' # å½“å·¥ä½œæµæ–‡ä»¶æœ¬èº«ä¿®æ”¹æ—¶ä¹Ÿè§¦å‘ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

permissions:
  contents: write # å…è®¸ workflow æäº¤ä»£ç ä¿®æ”¹ (ä¿®æ”¹ mirror-list.txt)

# å·¥ä½œæµæ ¸å¿ƒä»»åŠ¡
jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # å®‰è£… Skopeo å·¥å…· (ç”¨äºæ”¯æŒå¤šæ¶æ„é•œåƒåŒæ­¥)
      - name: å®‰è£… Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      # é…ç½®é˜¿é‡Œäº‘ ACR å‚æ•°
      - name: é…ç½®é˜¿é‡Œäº‘ACRå‚æ•°
        run: |
          echo "ALIYUN_REGISTRY=${{ secrets.ALIYUN_REGISTRY || 'registry.cn-hangzhou.aliyuncs.com' }}" >> $GITHUB_ENV
          echo "ALIYUN_NAMESPACE=${{ secrets.ALIYUN_NAMESPACE || 'my-docker-repo' }}" >> $GITHUB_ENV
          echo "ALIYUN_USERNAME=${{ secrets.ALIYUN_USERNAME || 'ä½ çš„é˜¿é‡Œäº‘è´¦å·' }}" >> $GITHUB_ENV
          echo "ALIYUN_PASSWORD=${{ secrets.ALIYUN_PASSWORD || 'ä½ çš„é˜¿é‡Œäº‘ACRå¯†ç ' }}" >> $GITHUB_ENV

      # ç™»å½•é˜¿é‡Œäº‘ ACR (ä½¿ç”¨ skopeo login)
      - name: ç™»å½•é˜¿é‡Œäº‘ACR
        run: |
          echo "æ­£åœ¨ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
          skopeo login ${{ env.ALIYUN_REGISTRY }} -u ${{ env.ALIYUN_USERNAME }} -p ${{ env.ALIYUN_PASSWORD }}

      # æ‰¹é‡åŒæ­¥é•œåƒ
      - name: æ‰¹é‡åŒæ­¥é•œåƒ
        id: sync
        run: |
          # æ£€æŸ¥ mirror-list.txt æ˜¯å¦å­˜åœ¨
          if [ ! -f mirror-list.txt ]; then
            echo "âŒ é”™è¯¯: mirror-list.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi

          echo "å¼€å§‹è¯»å–é•œåƒåˆ—è¡¨..."
          # ä½¿ç”¨ Python è„šæœ¬è·å– pending åˆ—è¡¨
          PENDING_IMAGES=$(python3 utils/manage_list.py get_pending)
          
          if [ -z "$PENDING_IMAGES" ]; then
            echo "æ²¡æœ‰éœ€è¦åŒæ­¥çš„é•œåƒ (Pending list is empty)."
            exit 0
          fi

          SUCCESS_LIST=""

          # è®¾ç½® Internal Field Separator ä¸ºæ¢è¡Œç¬¦ï¼Œä»¥ä¾¿æ­£ç¡®å¤„ç†å¤šè¡Œè¾“å‡º
          IFS=$'\n'
          for SOURCE_IMAGE in $PENDING_IMAGES; do
            echo "----------------------------------------------------"
            echo "ğŸš€ æ­£åœ¨å¤„ç†: $SOURCE_IMAGE"
            
            # è®¡ç®—ç›®æ ‡é•œåƒåç§°
            IMAGE_NAME=$(echo $SOURCE_IMAGE | awk -F '/' '{print $NF}')
            TARGET_IMAGE="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${IMAGE_NAME}"
            
            # æ„é€ å®Œæ•´çš„æºå’Œç›®æ ‡å¼•ç”¨ (Skopeo éœ€è¦ docker:// å‰ç¼€)
            SRC_REF="docker://$SOURCE_IMAGE"
            DEST_REF="docker://$TARGET_IMAGE"

            # 0. æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨ï¼ˆå¯é€‰ï¼Œä½†æ—¢ç„¶ç”¨äº† pending/complete æœºåˆ¶ï¼Œè¿™é‡Œå¯ä»¥ä¿ç•™ä½œä¸ºåŒé‡ä¿é™©ï¼Œæˆ–è€…å»æ‰ä»¥åŠ é€Ÿï¼‰
            # è¿™é‡Œä¿ç•™æ£€æŸ¥ï¼Œé˜²æ­¢æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶å¯¼è‡´çš„é‡å¤åŒæ­¥
            echo "ğŸ” æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨: $TARGET_IMAGE"
            if skopeo inspect $DEST_REF > /dev/null 2>&1; then
              echo "âš ï¸  é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥ï¼"
              SUCCESS_LIST="$SUCCESS_LIST $SOURCE_IMAGE"
              echo "----------------------------------------------------"
              continue
            fi
            
            # 1. ä½¿ç”¨ Skopeo åŒæ­¥é•œåƒ (æ”¯æŒå¤šæ¶æ„ --all)
            echo "ğŸ”„ Syncing $SOURCE_IMAGE -> $TARGET_IMAGE ..."
            if skopeo copy --all $SRC_REF $DEST_REF; then
                echo "âœ… åŒæ­¥æˆåŠŸ: $SOURCE_IMAGE"
                SUCCESS_LIST="$SUCCESS_LIST $SOURCE_IMAGE"
            else
                echo "âŒ åŒæ­¥å¤±è´¥: $SOURCE_IMAGE"
            fi
          done
          unset IFS
          
          # å°†æˆåŠŸåˆ—è¡¨å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
          # æ³¨æ„ï¼šGitHub Actions ç¯å¢ƒå˜é‡ä¸æ”¯æŒç›´æ¥æ¢è¡Œï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæˆ–è€…å†™å…¥æ–‡ä»¶
          echo "SUCCESS_IMAGES=$SUCCESS_LIST" >> $GITHUB_ENV

      # æ›´æ–° mirror-list.txt å¹¶æäº¤
      - name: æ›´æ–°é•œåƒåˆ—è¡¨å¹¶æäº¤
        if: env.SUCCESS_IMAGES != ''
        run: |
          echo "æ­£åœ¨æ›´æ–° mirror-list.txt ..."
          # ä¼ å…¥æˆåŠŸåŒæ­¥çš„é•œåƒåˆ—è¡¨
          python3 utils/manage_list.py move_to_complete ${{ env.SUCCESS_IMAGES }}
          
          # é…ç½® git ç”¨æˆ·
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æäº¤ä¿®æ”¹
          git add mirror-list.txt
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update mirror-list.txt (move synced images to complete)"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€ä¿®æ”¹ã€‚"
          fi

      # ç™»å‡º
      - name: ç™»å‡ºé˜¿é‡Œäº‘ACR
        if: always()
        run: skopeo logout ${{ env.ALIYUN_REGISTRY }}

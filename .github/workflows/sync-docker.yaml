# å·¥ä½œæµåç§°ï¼Œè‡ªå®šä¹‰
name: Docker é•œåƒåŒæ­¥ (æ‹‰å– â†’ æŽ¨é€é˜¿é‡Œäº‘ACR)

# è§¦å‘è§„åˆ™ï¼š
on:
  # æ–¹å¼1ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ–¹å¼2ï¼šä»£ç æŽ¨é€è§¦å‘
  push:
    branches: [ "main", "master" ]
    paths:
      - 'mirror-list.txt'                   # å½“é•œåƒåˆ—è¡¨å˜åŒ–æ—¶è§¦å‘
      # - '.github/workflows/sync-docker.yaml' # å½“å·¥ä½œæµæ–‡ä»¶æœ¬èº«ä¿®æ”¹æ—¶ä¹Ÿè§¦å‘ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

# å·¥ä½œæµæ ¸å¿ƒä»»åŠ¡
jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # é…ç½®é˜¿é‡Œäº‘ ACR å‚æ•°
      - name: é…ç½®é˜¿é‡Œäº‘ACRå‚æ•°
        run: |
          echo "ALIYUN_REGISTRY=${{ secrets.ALIYUN_REGISTRY || 'registry.cn-hangzhou.aliyuncs.com' }}" >> $GITHUB_ENV
          echo "ALIYUN_NAMESPACE=${{ secrets.ALIYUN_NAMESPACE || 'my-docker-repo' }}" >> $GITHUB_ENV
          echo "ALIYUN_USERNAME=${{ secrets.ALIYUN_USERNAME || 'ä½ çš„é˜¿é‡Œäº‘è´¦å·' }}" >> $GITHUB_ENV
          echo "ALIYUN_PASSWORD=${{ secrets.ALIYUN_PASSWORD || 'ä½ çš„é˜¿é‡Œäº‘ACRå¯†ç ' }}" >> $GITHUB_ENV

      # ç™»å½•é˜¿é‡Œäº‘ ACR
      - name: ç™»å½•é˜¿é‡Œäº‘ACR
        run: |
          echo "æ­£åœ¨ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
          docker login ${{ env.ALIYUN_REGISTRY }} -u ${{ env.ALIYUN_USERNAME }} -p ${{ env.ALIYUN_PASSWORD }}

      # æ‰¹é‡åŒæ­¥é•œåƒ
      - name: æ‰¹é‡åŒæ­¥é•œåƒ
        run: |
          # æ£€æŸ¥ mirror-list.txt æ˜¯å¦å­˜åœ¨
          if [ ! -f mirror-list.txt ]; then
            echo "âŒ é”™è¯¯: mirror-list.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi

          echo "å¼€å§‹è¯»å–é•œåƒåˆ—è¡¨..."
          cat mirror-list.txt | grep -v '^#' | grep -v '^$' | while read -r SOURCE_IMAGE; do
            echo "----------------------------------------------------"
            echo "ðŸš€ æ­£åœ¨å¤„ç†: $SOURCE_IMAGE"
            
            # 1. æ‹‰å–é•œåƒ
            echo "ðŸ“¥ Pulling $SOURCE_IMAGE ..."
            docker pull $SOURCE_IMAGE
            
            # 2. æ‰“æ ‡ç­¾
            IMAGE_NAME=$(echo $SOURCE_IMAGE | awk -F '/' '{print $NF}')
            TARGET_IMAGE="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${IMAGE_NAME}"
            echo "ðŸ·ï¸ Tagging as $TARGET_IMAGE ..."
            docker tag $SOURCE_IMAGE $TARGET_IMAGE
            
            # 3. æŽ¨é€é•œåƒ
            echo "ðŸ“¤ Pushing to Aliyun ACR ..."
            docker push $TARGET_IMAGE
            
            echo "âœ… å®Œæˆ: $SOURCE_IMAGE -> $TARGET_IMAGE"
          done
          
      # ç™»å‡º
      - name: ç™»å‡ºé˜¿é‡Œäº‘ACR
        if: always()
        run: docker logout ${{ env.ALIYUN_REGISTRY }}
